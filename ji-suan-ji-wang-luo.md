# 计算机网络



## TCP 与 UDP简要说明

- 两者都是OSI模型中传输层的协议.
- TCP是全双工的可靠信道,UDP则是不可靠信道. 
- TCP的特性：属于面向连接的协议，需要三次握手与对方建立连接，即能为应用程序提供可靠的通信连接。断开连接需要四次挥手。 但是TCP也有一些缺点，如数据包和帧本身占用一些空间，并且面向连接的特性会有一些额外的通信量产生，速度较慢。比如文件传输就是使用的TCP协议. 
- UDP的特性：不属于连接型协议，因而具有资源消耗小，处理速度快的优点，所以通常音频、视频和普通数据在传送时使用UDP较多，因为它们即使偶尔丢失一两个数据包，也不会对接收结果产生太大影响。比如我们聊天用的QQ就是使用的UDP协议。 

## TCP 三次握手 

客户端A，服务端B。 **A主动打开连接，而B被动打开连接**。

1. 建立连接，A创建**传输控制模块TCB**，向B发出连接请求报文段，首部同步位SYN=1，同时选择一个初始序号seq =x。然后A进入SYN-SENT(同步已发送)状态。

2. B收到连接请求后，会向A发送确认报文段，(在报文段中)把SYN位和ACK位都置1，确认号ack = x+1,同时也为自己选择一个初始序号seq =y。这时B进入SYN-RCVD(同步收到)状态。

3. A收到B的确认后，还要向B给出确认。确认报文段的ACK置1，确认号ack = y+1，而自己的序号seq = x+1，发送完毕后，TCP连接已建立，A进入ESTABLISHED(已建立连接)状态。

   B收到A的确认后，也进入ESTABLISHED(已建立连接)状态。

   为什么A还要发送一次确认呢？ 主要是为了防止已失效的连接请求报文段突然又传送到 了B,因而出错。

   >所谓“已失效的连接请求报文段”是这样产生的： 
   >
   >​	即A发出的第一个连接请求报文段并没有丢失，而是在某些网络节点长时间滞留了，以致延误到连接释放以后的某个时间才能到达B。 本来这是一个早已失效的报文段。   但B收到此失效的连接请求报文段后，就误认为A又发出了一次新的连接请求。    于是又向A发出确认报文段，同意建立连接。    假定不采用三次握手，那么只要B发出确认，新的连接就建立了。  由于现在A并没有发出建立连接的请求，因此不会理财B的确认，也不会向B发送数据。 但B却以为新的运输连接已经建立了，并一直等待A发来数据。 B的许多资源就这样浪费了。
   >
   >　　采用三次握手的方法可以防止上述异常现象的发生。

   

## 四次挥手

客户端A，服务端B，数据传输结束后，通信的**双方都可释放连接**。现在A和B都处于ESTABLISHED状态。

1. 假定A主动关闭TCP连接。A把连接释放报文段首部的终止控制位FIN置为1，其序号seq = u，它等于前面已传送过的数据的最后一个字节的序号加1。这时A进入FIN-WAIT-1(终止等待1)状态，等待B的确认。

2. B收到连接释放报文段后即发出确认，确认号ack= u+1，而这个报文段序号是v，等于前面已传送过的数据的最后一个字节的序号加1。然后B就进入CLOSE-WAIT(关闭等待)状态。A收到B的确认后就进入FIN-WAIT-2（终止等待2）状态， 此时A到B方向的连接就释放，但B到A方向的连接未释放（若B发数据，A仍要接收）。

3. B若没有要向A发送数据，则发出连接释放报文段使FIN=1。假定B现在的序号为w，B还必须重复上次已发送过的确认号ack = u+1。这是B就进入LAST-ACK(最后确认)状态，等待A的确认。

4. A收到B的释放报文段后，再对此发出确认。在确认报文段中把ACK置为1，确认号ack = w+1，而自己的序号是seq = u+1。然后进入到TIME-WAIT(时间等待)状态。 必须经过时间等待计时器设置的时间2MSL后，A进入CLOSED状态。而B收到A的确认后就关闭连接。

   > A在TIME_WAIT等待2MSL的时间原因：
   >
   > 1. 为保证主机1发送的最后一个ACK报文段能够到达B。这个ACK报文段可能丢失。
   > 2. 防止“已失效的连接请求报文段”出现在本连接中。（这个时间可以使本连接持续的时间内所产生的所有报文段都从网络中消失）



## TCP重传机制

重传分为两种：超时重传和快速重传。 

**超时重传（RTO）**  

当一个包被发送后，就开启一个定时器，如果定时时间到了，还未收到能确认该发送包的应答包，就重传一份数据。注意收到的应答包可能是该包也可能是后面包的，但是只要能确认该包被收到就行。另外如果，是因为网络延时造成重传，则接受端收到重复数据包后丢弃该包。  

**快速重传**  当如果发送端收到一个包的三次应答包后，立即重传，比超时重传更高效。 

## TCP窗口

TCP在每个传输方向都有两个窗口，发送端窗口和接收端窗口，又因为TCP是全双工通信，因此有四个窗口。 

## 窗口滑动

一图胜千言，看下面的图。

简单解释下，发送和接受方都会维护一个数据帧的序列，这个序列被称作窗口。发送方的窗口大小由接受方确定，目的在于控制发送速度，以免接受方的缓存不够大，而导致溢出，同时控制流量也可以避免网络拥塞。下面图中的4,5,6号数据帧已经被发送出去，但是未收到关联的ACK，7,8,9帧则是等待发送。可以看出发送端的窗口大小为6，这是由接受端告知的（事实上必须考虑拥塞窗口cwnd，这里暂且考虑cwnd>rwnd）。此时如果发送端收到4号ACK，则窗口的左边缘向右收缩，窗口的右边缘则向右扩展，此时窗口就向前“滑动了”，即数据帧10也可以被发送。 

