# 计算机网络

## 计算机网络体系结构

![network-structure.png](https://github.com/Realee007/jobbook/blob/master/src/image/network-structure.png?raw=true) 

 **五层协议**

- **应用层** ：为特定应用程序提供数据传输服务，例如 HTTP、DNS 等。数据单位为报文。

- **运输层** ：提供的是进程间的通用数据传输服务。由于应用层协议很多，定义通用的运输层协议就可以支持不断增多的应用层协议。运输层包括两种协议：传输控制协议 TCP，提供面向连接、可靠的数据传输服务，数据单位为报文段；用户数据报协议 UDP，提供无连接、尽最大努力的数据传输服务，数据单位为用户数据报。TCP 主要提供完整性服务，UDP 主要提供及时性服务。

- **网络层** ：为主机间提供数据传输服务，而运输层协议是为主机中的进程提供服务。网络层把运输层传递下来的报文段或者用户数据报封装成分组。

- **数据链路层** ：网络层针对的还是主机之间的数据传输服务，而主机之间可以有很多链路，链路层协议就是为同一链路的节点提供服务。数据链路层把网络层传来的分组封装成帧。

- **物理层** ：考虑的是怎样在传输媒体上传输数据比特流，而不是指具体的传输媒体。物理层的作用是尽可能屏蔽传输媒体和通信手段的差异，使数据链路层感觉不到这些差异。

  注：五层协议的体系结构只是为介绍网络原理而设计，实际应用以TCP/IP四层体系结构为主。

### OSI七层模型

​	数据从应用层发下来，会在每一层都加上头部信息，进行封装，然后再发生到数据接收端。这个基本流程就是数据都会经过数据的封装和解封装过程。 

![data transport from osi 7.png](https://github.com/Realee007/jobbook/blob/master/src/image/data%20transport%20from%20osi%207.png?raw=true) 

在OSI七层模型中，每一层的作用和对应的协议如下: 

![osi seven.png](https://github.com/Realee007/jobbook/blob/master/src/image/osi%20seven.png?raw=true) 

### TCP/IP

 它只有四层，对于五层协议中，将数据链路层和物理层合并为网络接口层。

TCP/IP协议族的特点是：上下两头大而中间小。这种很像**沙漏**计时器形状。即TCP/IP协议可以为各式各样的应用提供服务(所谓everything over IP)，同时TCP/IP协议也允许IP协议在各式各样的网络构成的互联网上运行。

![TCP_IP_1.png](https://github.com/Realee007/jobbook/blob/master/src/image/TCP_IP_1.png?raw=true) 



注：随着技术的发展，现在的TCP/IP体系结构不严格遵循OSI分层概念，应用层可能会直接使用IP层或网络接口。



## 一. 物理层

- 物理层的主要任务就是确定与传输媒体的接口有关的一些特性。
- 传输媒体分为两大类：

1. 导引型传输媒体（双绞线、同轴电缆或光纤）
2. 非导引型传输媒体（无线或红外）

- 通信方式：

1. 单向通信（单工通信）
2. 双向交替通信（半双工通信）
3. 双向同时通信（全双工通信）

## 二. 数据链路层

- 链路是从一个结点到相邻结点的一段物理线路，数据链路则是在链路的基础上增加了一些必要的硬件（如网络适配器）和软件（如协议的实现）
- 数据链路层使用信道：1. 点对点信道；2. 广播信道
- 目前数据链路层广泛使用了循环冗余检验（CRC）来检查比特差错。

### 交换机

交换式集线器常称为以太网交换机，我们俗称的交换机是以太网交换机。

交换机具有自学习能力，学习的是交换表的内容，交换表中存储着 MAC 地址到接口的映射。正是由于这种自学习能力，因此交换机是一种即插即可即用设备，不需要网络管理员手动配置交换表内容。

下图中，交换机有 4 个接口，主机 A 向主机 B 发送数据帧时，交换机把主机 A 到接口 1 的映射写入交换表中。为了发送数据帧到 B，先查交换表，此时没有主机 B 的表项，那么主机 A 就发送广播帧，主机 C 和主机 D 会丢弃该帧。主机 B 收下之后，查找交换表得到主机 A 映射的接口为 1，就发送数据帧到接口 1，同时交换机添加主机 B 到接口 3 的映射。

![hub.png](https://github.com/Realee007/jobbook/blob/master/src/image/hub.png?raw=true) 



## 三. 网络层

网络层尽可能简单。网络层向上只提供简单灵活的、无连接的、**尽最大努力交付的数据报服务**。（因为网络层的端系统是有智能的计算机），网络层不提供服务质量的承诺，进程之间通信的可靠性由运输层负责。

下面讨论如何传递IP数据报：

与 IP 协议配套使用的还有三个协议：

- 地址解析协议 ARP（Address Resolution Protocol）
- 网际控制报文协议 ICMP（Internet Control Message Protocol）
- 网际组管理协议 IGMP（Internet Group Management Protocol）
- 

## 四. 运输层

### TCP 与 UDP简要说明

- 两者都是OSI模型中传输层的协议.
- TCP是全双工的可靠信道,UDP则是不可靠信道. 
- TCP的特性：属于面向连接的协议，需要三次握手与对方建立连接，即能为应用程序提供可靠的通信连接。断开连接需要四次挥手。 但是TCP也有一些缺点，如数据包和帧本身占用一些空间，并且面向连接的特性会有一些额外的通信量产生，速度较慢。比如文件传输就是使用的TCP协议. 
- UDP的特性：不属于连接型协议，因而具有资源消耗小，处理速度快的优点，所以通常音频、视频和普通数据在传送时使用UDP较多，因为它们即使偶尔丢失一两个数据包，也不会对接收结果产生太大影响。比如我们聊天用的QQ就是使用的UDP协议。 

### TCP 三次握手

客户端A，服务端B。 **A主动打开连接，而B被动打开连接**。

1. 建立连接，A创建**传输控制模块TCB**，向B发出连接请求报文段，首部同步位SYN=1，同时选择一个初始序号seq =x。然后A进入SYN-SENT(同步已发送)状态。

2. B收到连接请求后，会向A发送确认报文段，(在报文段中)把SYN位和ACK位都置1，确认号ack = x+1,同时也为自己选择一个初始序号seq =y。这时B进入SYN-RCVD(同步收到)状态。

3. A收到B的确认后，还要向B给出确认。确认报文段的ACK置1，确认号ack = y+1，而自己的序号seq = x+1，发送完毕后，TCP连接已建立，A进入ESTABLISHED(已建立连接)状态。

   B收到A的确认后，也进入ESTABLISHED(已建立连接)状态。

   为什么A还要发送一次确认呢？ 主要是为了防止已失效的连接请求报文段突然又传送到 了B,因而出错。

   > 所谓“已失效的连接请求报文段”是这样产生的： 
   >
   > ​	即A发出的第一个连接请求报文段并没有丢失，而是在某些网络节点长时间滞留了，以致延误到连接释放以后的某个时间才能到达B。 本来这是一个早已失效的报文段。   但B收到此失效的连接请求报文段后，就误认为A又发出了一次新的连接请求。    于是又向A发出确认报文段，同意建立连接。    假定不采用三次握手，那么只要B发出确认，新的连接就建立了。  由于现在A并没有发出建立连接的请求，因此不会理财B的确认，也不会向B发送数据。 但B却以为新的运输连接已经建立了，并一直等待A发来数据。 B的许多资源就这样浪费了。
   >
   > 　　采用三次握手的方法可以防止上述异常现象的发生。

   

### TCP四次挥手

客户端A，服务端B，数据传输结束后，通信的**双方都可释放连接**。现在A和B都处于ESTABLISHED状态。

1. 假定A主动关闭TCP连接。A把连接释放报文段首部的终止控制位FIN置为1，其序号seq = u，它等于前面已传送过的数据的最后一个字节的序号加1。这时A进入FIN-WAIT-1(终止等待1)状态，等待B的确认。

2. B收到连接释放报文段后即发出确认，确认号ack= u+1，而这个报文段序号是v，等于前面已传送过的数据的最后一个字节的序号加1。然后B就进入CLOSE-WAIT(关闭等待)状态。A收到B的确认后就进入FIN-WAIT-2（终止等待2）状态， 此时A到B方向的连接就释放，但B到A方向的连接未释放（若B发数据，A仍要接收）。

3. B若没有要向A发送数据，则发出连接释放报文段使FIN=1。假定B现在的序号为w，B还必须重复上次已发送过的确认号ack = u+1。这是B就进入LAST-ACK(最后确认)状态，等待A的确认。

4. A收到B的释放报文段后，再对此发出确认。在确认报文段中把ACK置为1，确认号ack = w+1，而自己的序号是seq = u+1。然后进入到TIME-WAIT(时间等待)状态。 必须经过时间等待计时器设置的时间2MSL后，A进入CLOSED状态。而B收到A的确认后就关闭连接。

   > A在TIME_WAIT等待2MSL的时间原因：
   >
   > 1. 为保证主机1发送的最后一个ACK报文段能够到达B。这个ACK报文段可能丢失。
   > 2. 防止“已失效的连接请求报文段”出现在本连接中。（这个时间可以使本连接持续的时间内所产生的所有报文段都从网络中消失）



### TCP重传机制

重传分为两种：超时重传和快速重传。 

**超时重传（RTO）**  

当一个包被发送后，就开启一个定时器，如果定时时间到了，还未收到能确认该发送包的应答包，就重传一份数据。注意收到的应答包可能是该包也可能是后面包的，但是只要能确认该包被收到就行。另外如果，是因为网络延时造成重传，则接受端收到重复数据包后丢弃该包。  

**快速重传**  当如果发送端收到一个包的三次应答包后，立即重传，比超时重传更高效。 

### TCP窗口

TCP在每个传输方向都有两个窗口，发送端窗口和接收端窗口，又因为TCP是全双工通信，因此有四个窗口。 

### 窗口滑动

一图胜千言，看下面的图。

![slider windows TCP.jpg](https://github.com/Realee007/jobbook/blob/master/src/image/slider%20windows%20TCP.jpg?raw=true) 

​	简单解释下，发送和接受方都会维护一个数据帧的序列，这个序列被称作窗口。发送方的窗口大小由接受方确定，目的在于控制发送速度，以免接受方的缓存不够大，而导致溢出，同时控制流量也可以避免网络拥塞。下面图中的4,5,6号数据帧已经被发送出去，但是未收到关联的ACK，7,8,9帧则是等待发送。可以看出发送端的窗口大小为6，这是由接受端告知的（事实上必须考虑拥塞窗口cwnd，这里暂且考虑cwnd>rwnd）。此时如果发送端收到4号ACK，则窗口的左边缘向右收缩，窗口的右边缘则向右扩展，此时窗口就向前“滑动了”，即数据帧10也可以被发送。 

### TCP/IP 长连接和短连接

**TCP/IP**  

TCP/IP是个协议组，可分为三个层次：网络层、传输层和应用层。  在网络层有: IP协议、ICMP协议、ARP协议、RARP协议和BOOTP协议。  

在传输层中有:TCP协议与UDP协议。  

在应用层有:

1. TCP包括FTP、HTTP、TELNET、SMTP等协议
2. UDP包括DNS、TFTP等协议  



**长连接：**client向server发起连接，server接受client连接，双方建立连接。client与server完成一次读写之后，它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接。 

这种方式下由于通讯连接一直存在。此种方式常用于P2P通信。

**短连接**：  

连接->传输数据->关闭连接

HTTP是无状态的，浏览器和服务器每进行一次HTTP操作，就建立一次连接，但任务结束就中断连接。也可以这样说：短连接是指SOCKET连接后发送后接收完数据后马上断开连接。  

### 怎样维护长连接

**方法1：应用层自己实现的心跳包**  

​	由应用程序自己发送心跳包来检测连接是否正常，大致的方法是：服务器在一个 Timer事件中定时向客户端发送一个短小精悍的数据包，然后启动一个低级别的线程，在该线程中不断检测客户端的回应， 如果在一定时间内没有收到客户端的回应，即认为客户端已经掉线；同样，如果客户端在一定时间内没 有收到服务器的心跳包，则认为连接不可用。 

**方法2：TCP的KeepAlive保活机制** 

## 

## http VS https

HTTPS和HTTP的区别主要如下：

　　1、https协议需要到ca申请证书，一般免费证书较少，因而需要一定费用。

　　2、http是超文本传输协议，信息是明文传输，https则是具有安全性的ssl加密传输协议。

　　3、http和https使用的是完全不同的连接方式，用的端口也不一样，前者是80，后者是443。

　　4、http的连接很简单，是无状态的；HTTPS协议是由SSL+HTTP协议构建的可进行加密传输、身份认证的网络协议，比http协议安全。